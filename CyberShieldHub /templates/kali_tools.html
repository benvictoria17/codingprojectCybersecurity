{% extends "layout.html" %}

{% block title %}Kali Linux Tools - CyberKidz{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow-sm animate__animated animate__fadeIn">
            <div class="card-body">
                <h1 class="card-title">
                    <i class="fas fa-dragon text-danger me-2"></i> Kali Linux Tools
                </h1>
                <p class="lead">
                    Learn about special security tools used by cybersecurity experts.
                </p>
                <p>
                    Kali Linux is a special computer system that has many security tools. These tools help security experts test and protect computers and networks. Here you can learn about these tools and see how they work.
                </p>
                <div class="alert alert-primary">
                    <i class="fas fa-info-circle me-2"></i> This is for education only. Never use these tools on computers or networks without permission.
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-dark text-white">
                <h5><i class="fas fa-terminal me-2"></i> Kali Tools</h5>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush" id="tools-menu">
                    <a href="#" class="list-group-item list-group-item-action active" data-category="all">
                        <i class="fas fa-dragon me-2"></i> All Tools
                    </a>
                    <a href="#" class="list-group-item list-group-item-action" data-category="information_gathering">
                        <i class="fas fa-search me-2"></i> Information Gathering
                    </a>
                    <a href="#" class="list-group-item list-group-item-action" data-category="vulnerability_analysis">
                        <i class="fas fa-bug me-2"></i> Vulnerability Analysis
                    </a>
                    <a href="#" class="list-group-item list-group-item-action" data-category="web_application_analysis">
                        <i class="fas fa-globe me-2"></i> Web App Analysis
                    </a>
                    <a href="#" class="list-group-item list-group-item-action" data-category="database_assessment">
                        <i class="fas fa-database me-2"></i> Database Assessment
                    </a>
                    <a href="#" class="list-group-item list-group-item-action" data-category="password_attacks">
                        <i class="fas fa-key me-2"></i> Password Attacks
                    </a>
                    <a href="#" class="list-group-item list-group-item-action" data-category="wireless_attacks">
                        <i class="fas fa-wifi me-2"></i> Wireless Attacks
                    </a>
                    <a href="#" class="list-group-item list-group-item-action" data-category="exploitation_tools">
                        <i class="fas fa-hammer me-2"></i> Exploitation Tools
                    </a>
                    <a href="#" class="list-group-item list-group-item-action" data-category="sniffing_spoofing">
                        <i class="fas fa-ethernet me-2"></i> Sniffing & Spoofing
                    </a>
                    <a href="#" class="list-group-item list-group-item-action" data-category="forensics">
                        <i class="fas fa-search-plus me-2"></i> Forensics
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-9">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-dark text-white d-flex align-items-center">
                <h5 class="mb-0"><i class="fas fa-laptop-code me-2"></i> Kali Linux Terminal</h5>
                <div class="ms-auto">
                    <button class="btn btn-sm btn-outline-light" id="help-btn">
                        <i class="fas fa-question-circle me-1"></i> Help
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="terminal-container" id="terminal-container">
                    <div class="terminal-header p-2 bg-dark text-light">
                        <div class="d-flex">
                            <div class="terminal-circle bg-danger me-1"></div>
                            <div class="terminal-circle bg-warning me-1"></div>
                            <div class="terminal-circle bg-success"></div>
                            <div class="ms-auto">Kali Linux Simulator</div>
                        </div>
                    </div>
                    <div class="terminal-body p-3" id="terminal-output">
                        <div class="terminal-line">
                            <span class="text-success">root@kali</span>:<span class="text-primary">~</span>$ Welcome to Kali Linux Simulator
                        </div>
                        <div class="terminal-line">
                            <span class="text-success">root@kali</span>:<span class="text-primary">~</span>$ Type 'help' or select a tool category from the menu
                        </div>
                        <div class="terminal-line terminal-prompt">
                            <span class="text-success">root@kali</span>:<span class="text-primary">~</span>$ <span class="terminal-cursor"></span>
                        </div>
                    </div>
                    <div class="terminal-input-container p-2 bg-dark">
                        <div class="input-group">
                            <span class="input-group-text bg-dark text-light border-0">$</span>
                            <input type="text" class="form-control bg-dark text-light border-0" id="terminal-input" placeholder="Type a command...">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card shadow-sm" id="tool-info-card" style="display: none;">
            <div class="card-header bg-info text-white">
                <h5 id="current-tool-name">Tool Information</h5>
            </div>
            <div class="card-body" id="tool-info">
                <!-- Tool information will be displayed here -->
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow-sm" id="tool-runner-container" style="display: none;">
            <div class="card-header bg-success text-white">
                <h5 id="active-tool-name"><i class="fas fa-play-circle me-2"></i> Running: <span></span></h5>
            </div>
            <div class="card-body">
                <form id="tool-parameters-form" class="mb-4">
                    <div class="row" id="tool-parameters">
                        <!-- Parameters for the selected tool will be displayed here -->
                    </div>
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                        <button type="button" class="btn btn-outline-secondary" id="cancel-tool-btn">
                            <i class="fas fa-times me-2"></i> Cancel
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-play-circle me-2"></i> Run Tool
                        </button>
                    </div>
                </form>
                
                <div id="tool-running-container" style="display: none;">
                    <div class="progress mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" 
                             style="width: 100%" id="tool-progress"></div>
                    </div>
                    
                    <div class="terminal-output bg-dark text-light p-3 rounded" id="tool-live-output">
                        <div class="terminal-line">Starting tool...</div>
                    </div>
                </div>
                
                <div id="tool-results-container" style="display: none;">
                    <h5 class="mt-4 mb-3">Results</h5>
                    
                    <div class="bg-dark p-3 mb-3 rounded" id="tool-output" style="font-family: monospace; color: #33ff33;">
                        <!-- Tool output will be displayed here -->
                    </div>
                    
                    <div id="tool-findings" class="mb-3">
                        <!-- Findings will be displayed here -->
                    </div>
                    
                    <h5>What I Learned</h5>
                    <div class="bg-info bg-opacity-10 p-3 rounded" id="tool-educational-notes">
                        <!-- Educational notes will be displayed here -->
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                        <button type="button" class="btn btn-primary" id="run-again-btn">
                            <i class="fas fa-redo me-2"></i> Run Again
                        </button>
                        <button type="button" class="btn btn-success" id="try-another-btn">
                            <i class="fas fa-tools me-2"></i> Try Another Tool
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tool Description Modal -->
<div class="modal fade" id="toolModal" tabindex="-1" aria-labelledby="toolModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="toolModalLabel">Tool Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="toolModalBody">
                <!-- Tool information will be displayed here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="simulateToolBtn">
                    <i class="fas fa-play-circle me-2"></i> Simulate This Tool
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const toolsForm = document.getElementById('tools-form');
    const toolCategory = document.getElementById('toolCategory');
    const toolResults = document.getElementById('tool-results');
    const toolSimulatorContainer = document.getElementById('tool-simulator-container');
    const toolSimulatorForm = document.getElementById('tool-simulator-form');
    const toolName = document.getElementById('toolName');
    const toolTarget = document.getElementById('toolTarget');
    const targetHelp = document.getElementById('targetHelp');
    const simulationResults = document.getElementById('simulation-results');
    const toolOutput = document.getElementById('tool-output');
    const toolFindings = document.getElementById('tool-findings');
    const simEducationalNotes = document.getElementById('sim-educational-notes');
    const toolModal = new bootstrap.Modal(document.getElementById('toolModal'));
    const simulateToolBtn = document.getElementById('simulateToolBtn');
    
    // Form submission for getting tools in a category
    toolsForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const category = toolCategory.value;
        if (!category) return;
        
        // Show loading
        toolResults.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading tools...</p>
            </div>
        `;
        
        // Fetch tool information
        fetch(`/api/kali-tools?category=${category}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    toolResults.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i> ${data.error}
                        </div>
                    `;
                    return;
                }
                
                // Display tools
                displayToolResults(data);
            })
            .catch(error => {
                console.error('Error:', error);
                toolResults.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i> Sorry, something went wrong. Please try again.
                    </div>
                `;
            });
    });
    
    // Display tool results
    function displayToolResults(data) {
        // Show educational notes first
        let html = `
            <div class="bg-info bg-opacity-10 p-3 mb-4 rounded">
                <h5><i class="fas fa-info-circle me-2"></i> About ${formatCategoryName(data.category)} Tools</h5>
                <ul class="mb-0">
        `;
        
        data.educational_notes.forEach(note => {
            html += `<li>${note}</li>`;
        });
        
        html += `
                </ul>
            </div>
            <h5 class="mb-3">Available Tools</h5>
            <div class="row row-cols-1 row-cols-md-2 g-3">
        `;
        
        // Display tool cards
        if (data.tools && data.tools.length > 0) {
            data.tools.forEach(tool => {
                html += `
                    <div class="col">
                        <div class="card h-100 tool-card" data-tool='${JSON.stringify(tool)}'>
                            <div class="card-body">
                                <h5 class="card-title">${tool.name}</h5>
                                <p class="card-text small">${tool.description}</p>
                                <div class="d-flex align-items-center mt-2">
                                    <span class="badge bg-${getDifficultyColor(tool.difficulty)} me-2">${tool.difficulty}</span>
                                    <button class="btn btn-sm btn-outline-primary ms-auto view-tool-btn">
                                        <i class="fas fa-info-circle me-1"></i> Details
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        } else {
            html += `
                <div class="col-12">
                    <div class="alert alert-warning">
                        No tools found in this category.
                    </div>
                </div>
            `;
        }
        
        html += `</div>`;
        toolResults.innerHTML = html;
        
        // Add event listeners to tool cards
        document.querySelectorAll('.view-tool-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tool = JSON.parse(this.closest('.tool-card').dataset.tool);
                showToolModal(tool);
            });
        });
    }
    
    // Show tool modal with details
    function showToolModal(tool) {
        const modalBody = document.getElementById('toolModalBody');
        document.getElementById('toolModalLabel').textContent = tool.name;
        
        let html = `
            <div class="row">
                <div class="col-12">
                    <h6 class="fw-bold">Description</h6>
                    <p>${tool.description}</p>
                    
                    <h6 class="fw-bold mt-3">Kid-Friendly Explanation</h6>
                    <p>${tool.kid_friendly_explanation}</p>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6 class="fw-bold">Difficulty Level</h6>
                            <span class="badge bg-${getDifficultyColor(tool.difficulty)}">${tool.difficulty}</span>
                        </div>
                        <div class="col-md-6">
                            <h6 class="fw-bold">Example Command</h6>
                            <code>${tool.example_command}</code>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        modalBody.innerHTML = html;
        toolModal.show();
        
        // Set up simulate button
        simulateToolBtn.onclick = function() {
            prepareToolSimulation(tool);
            toolModal.hide();
        };
    }
    
    // Prepare the tool simulation form
    function prepareToolSimulation(tool) {
        toolName.value = tool.name;
        toolTarget.value = '';
        toolSimulatorContainer.style.display = 'block';
        simulationResults.style.display = 'none';
        
        // Scroll to the simulator
        toolSimulatorContainer.scrollIntoView({behavior: 'smooth'});
        
        // Set help text based on the tool
        if (tool.name.toLowerCase() === 'nmap') {
            targetHelp.textContent = 'Enter an IP address (like 192.168.1.1) or domain name (like example.com)';
        } else if (tool.name.toLowerCase() === 'nikto') {
            targetHelp.textContent = 'Enter a website URL (like http://example.com)';
        } else if (tool.name.toLowerCase() === 'sqlmap') {
            targetHelp.textContent = 'Enter a URL with parameters (like http://example.com/page.php?id=1)';
        } else if (tool.name.toLowerCase() === 'john the ripper' || tool.name.toLowerCase() === 'john') {
            targetHelp.textContent = 'Enter a filename containing password hashes (like passwords.txt)';
        } else if (tool.name.toLowerCase() === 'aircrack-ng') {
            targetHelp.textContent = 'Enter a packet capture filename (like capture.cap)';
        } else {
            targetHelp.textContent = 'Enter a target for the tool';
        }
    }
    
    // Form submission for tool simulation
    toolSimulatorForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const tool = toolName.value;
        const target = toolTarget.value;
        
        if (!tool || !target) return;
        
        // Show loading
        simulationResults.style.display = 'block';
        toolOutput.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Running simulation...</p>
            </div>
        `;
        toolFindings.innerHTML = '';
        simEducationalNotes.innerHTML = '';
        
        // Create form data
        const formData = new FormData();
        formData.append('tool_name', tool);
        formData.append('target', target);
        
        // Send request
        fetch('/api/run-kali-tool', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                toolOutput.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i> ${data.error}
                    </div>
                `;
                return;
            }
            
            // Display output
            displaySimulationResults(data);
        })
        .catch(error => {
            console.error('Error:', error);
            toolOutput.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i> Sorry, something went wrong. Please try again.
                </div>
            `;
        });
    });
    
    // Display simulation results
    function displaySimulationResults(data) {
        // Display command output
        if (data.output && data.output.length > 0) {
            let outputHtml = '';
            data.output.forEach(line => {
                outputHtml += `<div class="text-light">${line}</div>`;
            });
            toolOutput.innerHTML = outputHtml;
        } else {
            toolOutput.innerHTML = '<div class="text-muted">No output available</div>';
        }
        
        // Display findings
        if (data.findings && data.findings.length > 0) {
            let findingsHtml = '<div class="list-group">';
            data.findings.forEach(finding => {
                findingsHtml += `
                    <div class="list-group-item">
                        <div class="d-flex align-items-center">
                            <span class="badge bg-${finding.severity.color_class} me-2">
                                ${finding.severity.icon} ${finding.severity.label}
                            </span>
                            <h6 class="mb-0">${finding.title}</h6>
                        </div>
                        <p class="mb-1 mt-2">${finding.description}</p>
                        <small class="text-muted">
                            <strong>Recommendation:</strong> ${finding.recommendation}
                        </small>
                    </div>
                `;
            });
            findingsHtml += '</div>';
            toolFindings.innerHTML = findingsHtml;
        } else {
            toolFindings.innerHTML = '<div class="alert alert-info">No security issues found.</div>';
        }
        
        // Display educational notes
        if (data.educational_notes && data.educational_notes.length > 0) {
            let notesHtml = '<ul class="mb-0">';
            data.educational_notes.forEach(note => {
                notesHtml += `<li>${note}</li>`;
            });
            notesHtml += '</ul>';
            simEducationalNotes.innerHTML = notesHtml;
        } else {
            simEducationalNotes.innerHTML = '<p>No educational notes available.</p>';
        }
    }
    
    // Helper function to get difficulty color
    function getDifficultyColor(difficulty) {
        switch (difficulty.toLowerCase()) {
            case 'easy':
                return 'success';
            case 'medium':
                return 'info';
            case 'hard':
                return 'warning';
            case 'very hard':
                return 'danger';
            default:
                return 'secondary';
        }
    }
    
    // Helper function to format category name
    function formatCategoryName(category) {
        return category
            .split('_')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
            .join(' ');
    }
});
</script>
{% endblock %}